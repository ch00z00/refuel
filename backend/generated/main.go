// Code generated by OpenAPI Generator (https://openapi-generator.tech); DO NOT EDIT.

/*
 * Re:Fuel API
 *
 * This is the API specification document for Re:Fuel, an application for
 * converting complexes into fuel for self-evolution.
 * It targets the MVP (Minimum Viable Product) features.
 *
 * API version: v1.0.0
 */

package main

import (
	"log"
	"net/http"

	"refuel/backend/app"
	refuelapi "refuel/backend/generated/go"

	"github.com/gin-gonic/gin"
)

func main() {
	log.Printf("Server started")

	// 1. Ginルーターを初期化
	ginRouter := gin.Default()

	// 2. アプリケーションコンテキスト（DB接続、バリデーターなど）をセットアップ
	appCtx, err := app.SetupApp()
	if err != nil {
		log.Fatalf("Failed to setup application: %v", err)
	}

	// 3. ビジネスロジックを実装したAPIサービスをインスタンス化
	apiService := app.NewAPIService(appCtx.DB, appCtx.Validate)

	// 4. 生成されたコントローラーにAPIサービスを渡し、ルーターに登録
	router := refuelapi.NewRouter(
		refuelapi.NewActionsAPIController(apiService),
		refuelapi.NewBadgesAPIController(apiService),
		refuelapi.NewComplexesAPIController(apiService),
		refuelapi.NewGoalsAPIController(apiService),
		refuelapi.NewHealthAPIController(apiService),
		refuelapi.NewUserBadgesAPIController(apiService),
	)

	// 5. Ginミドルウェア（CORS, Authなど）を設定
	app.SetupGinMiddlewares(ginRouter)

	// 6. 生成されたルーターのハンドラをGinルーターに登録
	//    openapi-generatorが生成したルーターはhttp.Handlerインターフェースを実装している
	ginRouter.Any("/*any", gin.WrapH(router))

	// 7. サーバーを起動
	log.Fatal(http.ListenAndServe(":8080", ginRouter))
}
